<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
<title>Topologic/Web</title>
<desc>An interactive primitive polytope visualiser.</desc>
<style type="text/css"><![CDATA[text
{
    font-family: sans-serif;
}

svg
{
    background: white;
}

#output line
{
    stroke: black;
    stroke-width: 0.01;
}]]></style>

<svg x="1" y="1" width="100%" height="100%" viewBox="-2 -2 4 4">
<g id="output" />
</svg>

<script type="application/ecmascript" xlink:href="topologic-json.js" />

<script type="application/ecmascript"><![CDATA[
var updateModel = Module.cwrap('updateModel', 'number', ['string', 'number', 'number']);
var updateProjection = Module.cwrap('updateProjection', 'number', []);
var getProjection = Module.cwrap('getProjection', 'string', []);
var addOrigin3 = Module.cwrap ('addOrigin3', 'number', ['number', 'number']);
var setOrigin3 = Module.cwrap ('setOrigin3', 'number', ['number', 'number']);
var addOrigin4 = Module.cwrap ('addOrigin4', 'number', ['number', 'number', 'number']);
var setOrigin4 = Module.cwrap ('setOrigin4', 'number', ['number', 'number', 'number']);

updateModel('cube', 3, 4);

function initialise()
{
    function renderWireframe(output, JSONData)
    {
        var data = eval(JSONData);

        for (i = 1; i < data.length; i++)
        {
            var newNode = document.createElementNS ('http://www.w3.org/2000/svg', 'line');

            newNode.setAttributeNS (null, 'x1', data[i]['x1']);
            newNode.setAttributeNS (null, 'x2', data[i]['x2']);
            newNode.setAttributeNS (null, 'y1', data[i]['y1']);
            newNode.setAttributeNS (null, 'y2', data[i]['y2']);

            output.appendChild (newNode);
        }
    }

    function render()
    {
        var r = updateProjection();

        var output = document.getElementById('output');

        while (output.hasChildNodes())
        {
            output.removeChild(output.lastChild);
        }

        renderWireframe (output, getProjection());
    }

    var output = document.getElementById('output');
    var leftDown = false;
    var otherDown = false;
    var lastMouseX = 0;
    var lastMouseY = 0;

    function processMouseDown(e)
    {
        if (e.button == 0)
        {
            leftDown = true;
        }
        else
        {
            otherDown = true;
        }
    }

    function processMouseUp(e)
    {
        if (e.button == 0)
        {
            leftDown = false;
        }
        else
        {
            otherDown = false;
        }
    }

    function processMove(e)
    {
        var x = e.clientX - lastMouseX;
        var y = e.clientY - lastMouseY;

        if (leftDown)
        {
            if (e.altKey)
            {
                addOrigin4(0, -x, y);
            }
            else
            {
                addOrigin4(-x, 0, y);
            }

            render();
        }

        if (otherDown)
        {
            addOrigin3(-x, -y);

            render();
        }

        lastMouseX = e.clientX;
        lastMouseY = e.clientY;
    }

    document.onmousedown = processMouseDown;
    document.onmouseup = processMouseUp;
    document.onmousemove = processMove;

    render();
}

initialise();
]]></script>

</svg>
