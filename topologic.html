<!doctype html>
<html lang="en-gb">
  <head>
    <meta charset="utf-8"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="description" content="Topologic is a simple renderer for higher dimensional geometric primitives and arbitrary dimensional IFSs. This page contains a port of Topologic to WebGL so that it will run right in your browser window."/>
    <meta name="author" content="Magnus Achim Deininger"/>
    <title>Topologic/V9</title>
    <style>
      * { font-family: sans-serif; }
      html, body { margin: 0; padding: 0; min-height: 100%; }
      canvas.emscripten { width: 100%; height: 100%; padding: 0; margin: 0 }
      #status { position: absolute; text-align: left; top: 1em; left: 1em; }
      #progress { position: absolute; text-align: left; bottom: 1em; left: 1em; display: none; }
      textarea#output { display: none; }
      div.ui-content { margin: 0; padding: 0; min-height: 100%; }
      form { margin: 0; padding: 0; }
      #export-popup { width: 80%; left: 10%; right: 10%; top: 10%; }
      #export-popup textarea { height: 20em !important; }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.css" />
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.js"></script>
  </head>
  <body>
   <div data-role="page" class="ui-responsive-panel">
    <div data-role="header">
      <a href="#options" data-icon="bars" data-dismissible="false">Settings</a>
      <a href="#" data-icon="action" onclick="updateHash(); window.setTimeout(function(){jQuery('#export').popup('open');},100);">Export/Import...</a>
    </div>
    <div data-role="main" class="ui-content jqm-content jqm-fullwidth">
    <canvas class="emscripten" id="canvas"></canvas>
    <progress value="0" max="100" id="progress"></progress>  
    <div id="status">Downloading Topologic/V9...</div>
    
    <textarea id="output"></textarea>
    <script type='text/javascript'>
      // connect to canvas
      var Module = {
        arguments: ['topologic-webgl'].concat(window.location.hash.substring(1).match(/[^+\s]+/g)),
        preRun: [],
        postRun: [],
        print: (function() {
          var element = document.getElementById('output');
          element.value = ''; // clear browser cache
          return function(text) {
            text = Array.prototype.slice.call(arguments).join(' ');
            element.value += text + "\n";
            element.scrollTop = 99999; // focus on bottom
          };
        })(),
        printErr: function(text) {
          text = Array.prototype.slice.call(arguments).join(' ');
          console.log(text);
        },
        canvas: document.getElementById('canvas'),
        setStatus: function(text) {
          if (Module.setStatus.interval) clearInterval(Module.setStatus.interval);
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var statusElement = document.getElementById('status');
          var progressElement = document.getElementById('progress');
          if (m) {
            text = m[1];
            progressElement.value = parseInt(m[2])*100;
            progressElement.max = parseInt(m[4])*100;
            progressElement.hidden = false;
          } else {
            progressElement.value = null;
            progressElement.max = null;
            progressElement.hidden = true;
          }
          statusElement.innerHTML = text;
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        },
        TOTAL_MEMORY: 268435456,
        doNotCaptureKeyboard: true
      };
      Module.setStatus('Downloading Topologic/V9...');
    </script>
    <script type='text/javascript' src="topologic-sdl.js"></script>
    <script type='text/javascript'>
var setRadius = Module.cwrap('setRadius', 'number', ['number', 'number']);
var setConstant = Module.cwrap('setConstant', 'number', ['number']);
var setPrecision = Module.cwrap('setPrecision', 'number', ['number']);
var updateModel = Module.cwrap('updateModel', 'number', ['string', 'string', 'number', 'number']);
var setActiveDimension = Module.cwrap ('setActiveDimension', 'number', ['number']);
var forceRedraw = Module.cwrap('forceRedraw', null, []);
var setFlameColouring = Module.cwrap('setFlameColouring', null, ['number']);
var setIFSParameters = Module.cwrap('setIFSParameters', null, ['number', 'number', 'number', 'number', 'number']);
var setColour = Module.cwrap('setColour', null, ['number', 'number', 'number', 'number', 'number']);
var setFlameParameters = Module.cwrap('setFlameParameters', null, ['number']);
var setViewportSize = Module.cwrap('setViewportSize', null, ['number','number']);
var resetColourMap = Module.cwrap('resetColourMap', null, []);
var getJSON = Module.cwrap('getJSON', 'string', []);
var getSVG = Module.cwrap('getSVG', 'string', []);
var parseJSON = Module.cwrap('parseJSON', null, ['string']);
var interpretDrag = Module.cwrap('interpretDrag', 'number', ['number','number','number']);

var topologicMaxDepth = 7;
var topologicModel='cube';
var topologicFormat='cartesian';
var topologicModelDepth=4;
var topologicModelRenderDepth=4;
var topologicModelPrecision=8.5;
var topologicModelRadius=1;
var topologicModelMinorRadius=0.5;
var topologicModelConstant=1;
var topologicActiveDimension=3;

var topologicIFSIterations=4;
var topologicIFSFunctions=3;
var topologicIFSSeed=0;
var topologicIFSPreRotate=true;
var topologicIFSPostRotate=false;

var topologicFlameColouring=false;
var topologicFlameVariants=3;

var topologicColour =
    [[1,1,1,1],
     [0,0,0,0.8],
     [0,0,0,0.5]];

var topologicIgnoreHashChange = false;

function parseHash()
{
    if (topologicIgnoreHashChange) return;

    parseJSON(window.location.hash.substring(1));
    forceRedraw();

    var val = jQuery.parseJSON(getJSON());
    topologicModel             = val['model'];
    topologicFormat            = val['coordinateFormat'];
    topologicModelDepth        = val['depth'];
    topologicModelRenderDepth  = val['renderDepth'];
    topologicModelPrecision    = val['polarPrecision'];
    topologicModelRadius       = val['radius'];
//    topologicModelMinorRadius  = val['minorRadius'];
//    topologicModelConstant     = val['constant'];
    topologicIFSIterations     = val['iterations'];
    topologicIFSSeed           = val['seed'];
    topologicIFSFunctions      = val['functions'];
    topologicIFSPreRotate      = val['preRotate'];
    topologicIFSPostRotate     = val['postRotate'];
//    topologicIFSFlameColouring = val['flameColouring'];
    topologicIFSFlameVariants  = val['flameCoefficients'];

    topologicColour = [ val['background'].slice(1),
                        val['wireframe'].slice(1),
                        val['surface'].slice(1) ];

    topologicUpdateDimension();
    topologicUpdateCurrentModelData();
}

window.addEventListener('hashchange', parseHash, false);

(function(){
    var x, y;
    jQuery('#canvas').on({ 'touchstart' : function(ev) {
        ev = ev.originalEvent.touches[0];
        x = ev.clientX;
        y = ev.clientY;
    }});

    jQuery('#canvas').on({ 'touchmove' : function(ev) {
        ev = ev.originalEvent.touches[0];

        interpretDrag(ev.clientX - x, ev.clientY - y, 0);

        x = ev.clientX;
        y = ev.clientY;

        forceRedraw();
    }});
})();

function topologicUpdateDimension()
{
    if (topologicActiveDimension < 2)
    {
        topologicActiveDimension = 2;
    }
    if (topologicActiveDimension > topologicModelRenderDepth)
    {
        topologicActiveDimension = topologicModelRenderDepth;
    }
    var output = document.getElementById('activeDimension');
    if (output)
    {
        output.textContent=topologicActiveDimension;
    }
    setActiveDimension(topologicActiveDimension);
}

function topologicUpdateCurrentModelData()
{
    if (topologicModel == 'sphere')
    {
        if (topologicModelDepth == topologicModelRenderDepth)
        {
            topologicModelDepth--;
        }
    }
    if ((topologicModel == 'moebius-strip') || (topologicModel == 'klein-bagel') || (topologicModel == 'plane') || (topologicModel == 'klein-bottle') || (topologicModel == 'torus') || (topologicModel == 'dinis-surface'))
    {
        if (topologicModelDepth != 2)
        {
            topologicModelDepth = 2;
        }
    }
    if (topologicModelDepth > topologicMaxDepth)
    {
        topologicModelDepth = topologicMaxDepth;
    }
    if (topologicModelDepth < 1)
    {
        topologicModelDepth = 1;
    }
    if (topologicModelRenderDepth < 2)
    {
        topologicModelRenderDepth = 2;
    }
    if (topologicModelRenderDepth > topologicMaxDepth)
    {
        topologicModelRenderDepth = topologicMaxDepth;
    }
    if (topologicModelRenderDepth < topologicModelDepth)
    {
        topologicModelRenderDepth = topologicModelDepth;
    }
    if (topologicActiveDimension > topologicModelRenderDepth)
    {
        topologicUpdateDimension();
    }

    var output = document.getElementById('model');
    if (output)
    {
        output.value=topologicModel;
        jQuery('#model').selectmenu('refresh');
    }
    output = document.getElementById('format');
    if (output)
    {
        output.value=topologicFormat;
        jQuery('#format').selectmenu('refresh');
    }
    output = document.getElementById('modelDepth');
    if (output)
    {
        output.value=topologicModelDepth;
    }
    output = document.getElementById('modelRenderDepth');
    if (output)
    {
        output.value=topologicModelRenderDepth;
    }
    output = document.getElementById('modelPrecision');
    if (output)
    {
        output.value=topologicModelPrecision;
    }
    output = document.getElementById('modelRadius');
    if (output)
    {
        output.value=topologicModelRadius;
    }
    output = document.getElementById('modelMinorRadius');
    if (output)
    {
        output.value=topologicModelMinorRadius;
    }
    output = document.getElementById('modelConstant');
    if (output)
    {
        output.value=topologicModelConstant;
    }
    if (topologicIFSIterations < 2)
    {
        topologicIFSIterations = 2;
    }
    if (topologicIFSFunctions < 2)
    {
        topologicIFSFunctions = 2;
    }
    if (topologicFlameVariants < 1)
    {
        topologicFlameVariants = 1;
    }
    output = document.getElementById('IFSIterations');
    if (output)
    {
        output.value=topologicIFSIterations;
    }
    output = document.getElementById('IFSSeed');
    if (output)
    {
        output.value=topologicIFSSeed;
    }
    output = document.getElementById('IFSFunctions');
    if (output)
    {
        output.value=topologicIFSFunctions;
    }
    output = document.getElementById('FlameVariants');
    if (output)
    {
        output.value=topologicFlameVariants;
    }
}

function topologicUpdateCurrentModel()
{
    topologicUpdateCurrentModelData();

    setRadius(topologicModelRadius, topologicModelMinorRadius);
    setConstant(topologicModelConstant);
    setPrecision(topologicModelPrecision);

    setIFSParameters(topologicIFSIterations, topologicIFSSeed, topologicIFSFunctions, topologicIFSPreRotate, topologicIFSPostRotate);
    setFlameColouring(topologicFlameColouring);
    setFlameParameters(topologicFlameVariants);

    setColour(0, topologicColour[0][0], topologicColour[0][1], topologicColour[0][2], topologicColour[0][3]);
    setColour(1, topologicColour[1][0], topologicColour[1][1], topologicColour[1][2], topologicColour[1][3]);
    setColour(2, topologicColour[2][0], topologicColour[2][1], topologicColour[2][2], topologicColour[2][3]);

    forceRedraw();
    updateModel(topologicFormat, topologicModel, topologicModelDepth, topologicModelRenderDepth);

    topologicIgnoreHashChange = true;
    window.location.hash = getJSON();
    topologicIgnoreHashChange = false;
}

function updateHash(silent)
{
    silent = typeof silent !== 'undefined' ? silent : true;

    topologicIgnoreHashChange = silent;
    window.location.hash = getJSON();
    topologicIgnoreHashChange = !silent;
}

(function() {
    var canvas = document.getElementById('canvas');

    if (!canvas)
    {
        return;
    }

    window.addEventListener('resize', resizeCanvas, false);
    window.setTimeout(resizeCanvas, 100);

    function resizeCanvas()
    {
        canvas.width  = window.innerWidth;
        canvas.height = window.innerHeight;
        setViewportSize(canvas.width, canvas.height);
    }

    resizeCanvas();
})();
</script>
    </div>
    <div data-role="panel" id="options" data-display="overlay" data-dismissible="false">
     <ul data-role="listview">
      <li data-icon="delete"><a href="#" data-rel="close">Close</a></li>
      <li>
      <label for="activeDimension">Active Dimension</label>
      <input type="number" id="activeDimension" name="activeDimension" onchange="topologicActiveDimension=this.value; topologicUpdateDimension();" min="3" max="7" step="1" value="3"/>
      </li>
     </ul>
      <div data-role="collapsibleset" data-inset="false">
      <div data-role="collapsible">
      <h3>Help</h3>
      <p>Drag the mouse to rotate in the currently active dimension; scroll to zoom in or out.</p>
      </div>
      <div data-role="collapsible" data-collapsed="false">
      <h3>Model Parameters</h3>
      <label for="model">Model</label>
      <select id="model" onchange="topologicModel=this.value; topologicUpdateCurrentModel();">
            <option>simplex</option>
            <option selected="selected">cube</option>
            <option>plane</option>
            <option>sphere</option>
            <option>torus</option>
            <option>clifford-torus</option>
            <option>dinis-surface</option>
            <option>moebius-strip</option>
            <option>klein-bagel</option>
            <option>klein-bottle</option>
            <option>sierpinski-gasket</option>
            <option>sierpinski-carpet</option>
            <option>random-affine-ifs</option>
            <option>random-flame</option>
      </select>
      <label for="format">Format</label>
      <select id="format" onchange="topologicFormat=this.value; topologicUpdateCurrentModel();">
            <option selected="selected">cartesian</option>
            <option>polar</option>
      </select>
      <label for="modelDepth">Model Depth</label>
      <input type="number" id="modelDepth" name="modelDepth" onchange="topologicModelDepth=this.value; topologicUpdateCurrentModel();" min="1" max="7" step="1" value="4"/>
      <label for="renderDepth">Render Depth</label>
      <input type="number" id="modelRenderDepth" name="modelRenderDepth" onchange="topologicModelRenderDepth=this.value; topologicUpdateCurrentModel();" min="2" max="7" step="1" value="4"/>
      </div>
      <div data-role="collapsible">
      <h3>Base Parameters</h3>
      <label for="modelRadius">Major Radius</label>
      <input type="range" id="modelRadius" name="modelRadius" onchange="topologicModelRadius=this.value; topologicUpdateCurrentModel();" min="1" max="30" value="1"/>
      <label for="modelMinorRadius">Minor Radius</label>
      <input type="range" id="modelMinorRadius" name="modelMinorRadius" onchange="topologicModelMinorRadius=this.value; topologicUpdateCurrentModel();" min="-9" max="9" value="0.5"/>
      <label for="modelConstant">Constant</label>
      <input type="range" id="modelConstant" name="modelConstant" onchange="topologicModelConstant=this.value; topologicUpdateCurrentModel();" min="-20" max="20" value="1"/>
      <label for="modelPrecision">Precision</label>
      <input type="range" id="modelPrecision" name="modelPrecision" onchange="topologicModelPrecision=this.value; topologicUpdateCurrentModel();" min="1" max="40" value="8.5"/>
      </div>
      <div data-role="collapsible">
      <h3>IFS Parameters</h3>
      <label for="IFSIterations">Iterations</label>
      <input type="number" id="IFSIterations" name="IFSIterations" onchange="topologicIFSIterations=this.value; topologicUpdateCurrentModel();" min="0" step="1" value="4"/>
      <label for="IFSSeed">Seed</label>
      <input type="number" id="IFSSeed" name="IFSSeed" onchange="topologicIFSSeed=this.value; topologicUpdateCurrentModel();" min="0" step="1" value="0"/>
      <label for="IFSFunctions">Functions</label>
      <input type="number" id="IFSFunctions" name="IFSFunctions" onchange="topologicIFSFunctions=this.value; topologicUpdateCurrentModel();" min="1" step="1" value="3"/>
      <input type="checkbox" id="preRotate" checked="checked"
                     onclick="topologicIFSPreRotate=this.checked; topologicUpdateCurrentModel();"/>
      <label for="preRotate">Post-translation rotations</label>
      <input type="checkbox" id="postRotate"
                     onclick="topologicIFSPostRotate=this.checked; topologicUpdateCurrentModel();"/>
      <label for="postRotate">Post-translation rotations</label>
      </div>
      <div data-role="collapsible">
      <h3>Fractal Flame Parameters</h3>
      <label for="Flame Variants">Variants</label>
      <input type="number" id="FlameVariants" name="FlameVariants" onchange="topologicFlameVariants=this.value; topologicUpdateCurrentModel();" min="1" step="1" value="3"/>
      <input type="checkbox" id="flameColouring"
                     onclick="topologicFlameColouring=this.checked; topologicUpdateCurrentModel();"/>
      <label for="flameColouring">Fractal Flame Colouring</label>
      </div>
      <div data-role="collapsible">
      <h3>Colours</h3>
      <input type="button" value="White/Black" onclick="topologicColour=[[1,1,1,1],[0,0,0,0.8],[0,0,0,0.5]]; topologicUpdateCurrentModel();"/>
      <input type="button" value="Default" onclick="topologicColour=[[0.45,0.45,0.65,1],[1,1,1,1],[1,1,1,0.1]]; topologicUpdateCurrentModel();"/>
      <input type="button" value="Randomise Flame Colours" onclick="resetColourMap();"/>
      </div>
      </div>
    </div>
    <div data-role="popup" id="export">
      <div data-role="header">
        <h3>Export/Import</h3>
      </div>
      <div role="main" class="ui-content">
        <textarea id="exportData"></textarea>
      </div>
      <input type="button" value="Export JSON" data-inline="true" onclick="document.getElementById('exportData').value = getJSON();"/>
      <input type="button" value="Export SVG" data-inline="true" onclick="document.getElementById('exportData').value = getSVG();"/>
      <input type="button" value="Import JSON" data-inline="true" onclick="window.location.hash = document.getElementById('exportData').value;"/>
    </div>
   </div>
   <script type='text/javascript'>window.setTimeout(function() { parseHash(); updateHash(); }, 100);</script>
  </body>
</html>
